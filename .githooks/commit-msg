#!/usr/bin/env sh
set -eu

msg_file="$1"
plan_file="docs/commit-plan.md"
subject="$(sed -n '1p' "$msg_file" | tr -d '\r')"

conventional='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9._/-]+\))?!?: .+'
ai_trace='(chatgpt|openai|claude|anthropic|copilot|cursor[[:space:]]*ai|ai-assisted|ai generated|generated by ai|generated with ai|llm)'

if ! printf '%s' "$subject" | grep -Eq "$conventional"; then
  echo "Invalid commit subject. Use conventional commits (e.g. feat(api): add trigger endpoint)." >&2
  exit 1
fi

if ! grep -Eqi '^planned-date:' "$msg_file"; then
  echo "Commit body must include a 'planned-date: YYYY-MM-DD' line." >&2
  exit 1
fi

planned_date="$(awk '
{
  line=$0
  lower=tolower(line)
  if (index(lower, "planned-date:") == 1) {
    sub(/^[^:]*:[[:space:]]*/, "", line)
    sub(/[[:space:]]+$/, "", line)
    print line
    exit
  }
}' "$msg_file")"

if ! printf '%s' "$planned_date" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
  echo "Invalid planned-date. Use format YYYY-MM-DD." >&2
  exit 1
fi

if ! grep -Eqi '^why:' "$msg_file"; then
  echo "Commit body must include a 'why:' section." >&2
  exit 1
fi

if ! grep -Eqi '^what:' "$msg_file"; then
  echo "Commit body must include a 'what:' section." >&2
  exit 1
fi

if ! grep -Eqi '^verification:' "$msg_file"; then
  echo "Commit body must include a 'verification:' section." >&2
  exit 1
fi

if grep -Eqi '^co-authored-by:' "$msg_file"; then
  echo "Co-authored-by trailers are not allowed for this repository." >&2
  exit 1
fi

if grep -Eqi "$ai_trace" "$msg_file"; then
  echo "AI trace text is not allowed in commit messages for this repository." >&2
  exit 1
fi

expected_date=""
if [ -f "$plan_file" ]; then
  expected_date="$(awk -F'|' -v target="$subject" '
    /^\|[[:space:]]*[0-9]{4}-[0-9]{2}-[0-9]{2}[[:space:]]*\|/ {
      date=$2
      commit_subject=$4
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", date)
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", commit_subject)
      gsub(/^`/, "", commit_subject)
      gsub(/`$/, "", commit_subject)
      if (commit_subject == target) {
        print date
        exit
      }
    }' "$plan_file")"
fi

if [ -n "$expected_date" ] && [ "$planned_date" != "$expected_date" ]; then
  echo "planned-date '$planned_date' does not match milestone date '$expected_date' for this subject." >&2
  exit 1
fi
