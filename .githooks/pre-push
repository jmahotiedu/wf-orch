#!/usr/bin/env sh
set -eu

plan_file="docs/commit-plan.md"
zero_sha="0000000000000000000000000000000000000000"
conventional='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9._/-]+\))?!?: .+'
ai_trace='(chatgpt|openai|claude|anthropic|copilot|cursor[[:space:]]*ai|ai-assisted|ai generated|generated by ai|generated with ai|llm)'

get_expected_date_for_subject() {
  target_subject="$1"
  if [ ! -f "$plan_file" ]; then
    return 0
  fi

  awk -F'|' -v target="$target_subject" '
    /^\|[[:space:]]*[0-9]{4}-[0-9]{2}-[0-9]{2}[[:space:]]*\|/ {
      date=$2
      commit_subject=$4
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", date)
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", commit_subject)
      gsub(/^`/, "", commit_subject)
      gsub(/`$/, "", commit_subject)
      if (commit_subject == target) {
        print date
        exit
      }
    }' "$plan_file"
}

extract_planned_date() {
  message_file="$1"
  awk '
  {
    line=$0
    lower=tolower(line)
    if (index(lower, "planned-date:") == 1) {
      sub(/^[^:]*:[[:space:]]*/, "", line)
      sub(/[[:space:]]+$/, "", line)
      print line
      exit
    }
  }' "$message_file"
}

tmp_refs="$(mktemp)"
tmp_commits="$(mktemp)"
tmp_sorted="$(mktemp)"
tmp_msg="$(mktemp)"

cleanup() {
  rm -f "$tmp_refs" "$tmp_commits" "$tmp_sorted" "$tmp_msg"
}
trap cleanup EXIT HUP INT TERM

cat > "$tmp_refs"

if [ ! -s "$tmp_refs" ]; then
  exit 0
fi

while read -r local_ref local_sha remote_ref remote_sha; do
  [ -z "${local_sha:-}" ] && continue
  [ "$local_sha" = "$zero_sha" ] && continue

  if [ "${remote_sha:-$zero_sha}" = "$zero_sha" ]; then
    git rev-list "$local_sha" >> "$tmp_commits"
  else
    git rev-list "${remote_sha}..${local_sha}" >> "$tmp_commits"
  fi
done < "$tmp_refs"

if [ ! -s "$tmp_commits" ]; then
  exit 0
fi

sort -u "$tmp_commits" > "$tmp_sorted"

while read -r sha; do
  [ -z "$sha" ] && continue

  subject="$(git log -1 --format='%s' "$sha" | tr -d '\r')"
  full_message="$(git log -1 --format='%s%n%b' "$sha")"
  author_date="$(git log -1 --date=short --format='%ad' "$sha" | tr -d '\r')"
  committer_date="$(git log -1 --date=short --format='%cd' "$sha" | tr -d '\r')"

  printf '%s\n' "$full_message" > "$tmp_msg"

  if ! printf '%s' "$subject" | grep -Eq "$conventional"; then
    echo "Push blocked: commit $sha has a non-conventional subject: $subject" >&2
    exit 1
  fi

  if ! grep -Eqi '^why:' "$tmp_msg"; then
    echo "Push blocked: commit $sha is missing a 'why:' section." >&2
    exit 1
  fi

  if ! grep -Eqi '^what:' "$tmp_msg"; then
    echo "Push blocked: commit $sha is missing a 'what:' section." >&2
    exit 1
  fi

  if ! grep -Eqi '^verification:' "$tmp_msg"; then
    echo "Push blocked: commit $sha is missing a 'verification:' section." >&2
    exit 1
  fi

  if grep -Eqi '^co-authored-by:' "$tmp_msg"; then
    echo "Push blocked: commit $sha includes a Co-authored-by trailer." >&2
    exit 1
  fi

  if grep -Eqi "$ai_trace" "$tmp_msg"; then
    echo "Push blocked: commit $sha contains AI trace text." >&2
    exit 1
  fi

  planned_date="$(extract_planned_date "$tmp_msg")"
  expected_date="$(get_expected_date_for_subject "$subject")"

  if [ -z "$planned_date" ]; then
    if [ -n "$expected_date" ]; then
      planned_date="$expected_date"
    else
      echo "Push blocked: commit $sha is missing 'planned-date: YYYY-MM-DD'." >&2
      exit 1
    fi
  fi

  if ! printf '%s' "$planned_date" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
    echo "Push blocked: commit $sha has invalid planned-date '$planned_date'." >&2
    exit 1
  fi

  if [ -n "$expected_date" ] && [ "$planned_date" != "$expected_date" ]; then
    echo "Push blocked: commit $sha planned-date '$planned_date' does not match plan date '$expected_date'." >&2
    exit 1
  fi

  if [ "$author_date" != "$planned_date" ]; then
    echo "Push blocked: commit $sha author date '$author_date' does not match planned-date '$planned_date'." >&2
    exit 1
  fi

  if [ "$committer_date" != "$planned_date" ]; then
    echo "Push blocked: commit $sha committer date '$committer_date' does not match planned-date '$planned_date'." >&2
    exit 1
  fi
done < "$tmp_sorted"
